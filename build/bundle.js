let e;var t;(t=e||(e={}))[t.Image=0]="Image",t[t.Audio=1]="Audio";class s{constructor(e,t){this.x=e,this.y=t}static equal(e,t){return e.x===t.x&&e.y===t.y}shifted(e){return new s(this.x+e.x,this.y+e.y)}multiplied(e){return new s(this.x*e,this.y*e)}angleTo(e){return Math.atan2(e.y-this.y,e.x-this.x)}distTo(e){const t=e.x-this.x,s=e.y-this.y;return Math.hypot(t,s)}scaled(e,t){return new s(this.x/e*t,this.y/e*t)}centred(e){return new s(this.x+e/2,this.y+e/2)}isInside(e){return this.x>=e.x&&this.x<=e.x+e.width&&this.y>=e.y&&this.y<=e.y+e.height}clone(){return new s(this.x,this.y)}}class o{constructor(e,t,s,o){this.x=e,this.y=t,this.width=s,this.height=o}overlaps(e){return this.x<e.x+e.width&&this.x+this.width>e.x&&this.y<e.y+e.height&&this.y+this.height>e.y}static fromVecs(e,t){return new o(e.x,e.y,t.x,t.y)}}const n=(e,t)=>Math.floor(Math.random()*(t-e+1))+e,i=(e,t,s=e.roomAt(e.playerRoomPos))=>{const n=e.ecs.getComponent(t,C);if(e.ecs.hasComponent(t,z))return s.entities.some((s=>{if(s===t)return!1;if(e.ecs.hasComponent(s,z)){const o=e.ecs.getComponent(s,z).getActualHitbox(e.ecs.getComponent(s,C));return e.ecs.getComponent(t,z).getActualHitbox(n).overlaps(o)}return!1}));{const s=e.ecs.getComponent(e.leftHandItemBox,z).getActualHitbox(e.ecs.getComponent(e.leftHandItemBox,C)),i=e.ecs.getComponent(e.rightHandItemBox,z).getActualHitbox(e.ecs.getComponent(e.rightHandItemBox,C));e.ecs.addComponent(t,z,[new o(0,0,e.tileSize,e.tileSize)]);const a=e.ecs.getComponent(t,z).getActualHitbox(n);let r;return r=!(!s.overlaps(a)&&!i.overlaps(a)),e.ecs.removeComponent(t,z),r}},a=(e,t,s)=>{if(t.allEmpty()||s.x<e.tileSize/2||s.y<e.tileSize/2||s.x>(e.roomSize.x-1)*e.tileSize-e.tileSize/2||s.y>(e.roomSize.y-1)*e.tileSize-e.tileSize/2)return!1;const[o,n]=t.takeItem(),a=e.ecs.getComponent(o,C),l=a.pixels.clone();return a.pixels=s,i(e,o)?(a.pixels=l,t.addItem(o,n),!1):(a.room=a.room.clone(),e.ecs.bringToFront(o),e.ecs.entitiesWithComponents(e.roomAt(e.playerRoomPos),[I]).forEach(e.ecs.bringToFront,e.ecs),e.shouldPlaySFX&&r(e.getAudio("place")).play(),!0)},r=e=>e.cloneNode(),l=(e,t)=>{const s=e.ecs.getComponent(t,C),o=e.ecs.getComponent(t,S),n=o.speedX*e.tileSize/e.currentFrameRate,a=o.speedY*e.tileSize/e.currentFrameRate;s.pixels.x+=n,(i(e,t)||t!==e.player&&(s.pixels.x<e.tileSize/2||s.pixels.x>e.canvas.width-1.5*e.tileSize))&&(s.pixels.x-=n),s.pixels.y+=a,(i(e,t)||t!==e.player&&(s.pixels.y<e.tileSize/2||s.pixels.y>e.canvas.height-1.5*e.tileSize))&&(s.pixels.y-=a)},c=(e,t,o)=>{let a;do{a=new s((n(2,e.roomSize.x-3)+Math.random()-.5)*e.tileSize,(n(2,e.roomSize.y-3)+Math.random()-.5)*e.tileSize),e.ecs.addComponent(o,C,[a,t.pos])}while(i(e,o,t))},h=(e,t)=>e.hasComponent(t,b);class m{}class d{components={};addComponent(e,t){this.components[e]=t}removeComponent(e){delete this.components[e]}getComponent(e){return this.components[e]}}let p;var g;(g=p||(p={}))[g.Tick=0]="Tick",g[g.Keyboard=1]="Keyboard",g[g.KeyUp=2]="KeyUp",g[g.Click=3]="Click",g[g.RightClick=4]="RightClick",g[g.Hit=5]="Hit";class u{requiredComponents=[];constructor(e,t,s){this.requiredComponents=e,this.trigger=t,this.update=s}}class y{systems=[];constructor(e){this.game=e}addSystem(e){this.systems.push(e)}updateSystems(e){const t=this.systems.filter((t=>t.trigger===e));for(const e of t)for(const t of this.game.ecs.entitiesWithComponents(this.game.roomAt(this.game.playerRoomPos),e.requiredComponents))e.update(this.game,t)}}class x{#e=[];componentManagers=new Map;constructor(e){this.systemManager=new y(e)}get entities(){return this.#e.filter((e=>!h(this,e)))}createEntity(){let e=this.#e.length;for(;this.#e.includes(e);)e++;return this.#e.push(e),e}removeEntity(e){this.#e.splice(this.#e.indexOf(e),1);for(const t of this.componentManagers.values())t.components[e]&&t.removeComponent(e)}bringToFront(e){this.#e.splice(this.#e.indexOf(e),1),this.#e.push(e)}hasComponent(e,t){return void 0!==this.componentManagers.get(t)?.getComponent(e)}addComponent(e,t,s=[]){this.componentManagers.has(t)||this.componentManagers.set(t,new d),this.componentManagers.get(t).addComponent(e,new t(...s))}getComponent(e,t){return this.componentManagers.get(t).getComponent(e)}removeComponent(e,t){this.componentManagers.get(t).removeComponent(e)}entitiesWithComponents(e,t){const s=[];for(const o of e.entities){let e=!0;for(const s of t)if(!this.hasComponent(o,s)){e=!1;break}e&&s.push(o)}return s}}class f{constructor(e,t,s,o,n){this.pos=e,this.angle=t,this.speed=s,this.friction=o,this.colour=n}static createBurst(e,t,s,o,n,i,a){for(let r=0;r<t;r++)setTimeout((()=>{e.particles.push(new f(o,Math.random()*Math.PI*2,n*(.75+.5*Math.random()),i,a))}),s*r)}}class C{constructor(e,t){this.pixels=e,this.room=t}getCentre(e){return new s(this.pixels.x+e/2,this.pixels.y+e/2)}}class w{timeOflastFrameChange=0;constructor(e,t,o){this.image=e,this.frame=t,this.dest=o||new s(null,null)}}class S{constructor(e){this.velocity=e,this.speedX=0,this.speedY=0}speedsTo(e,t){const s=Math.hypot(e,t);return[e/s*this.velocity,t/s*this.velocity]}get currentVelocity(){return Math.hypot(this.speedX,this.speedY)}}class z extends o{constructor(e){super(e.x,e.y,e.width,e.height)}getActualHitbox(e){return new z(new o(this.x+e.pixels.x,this.y+e.pixels.y,this.width,this.height))}}class v{constructor(e,t){this.leftHand=e,this.rightHand=t}hasSpace(){return null===this.leftHand||null===this.rightHand}allEmpty(){return null===this.leftHand&&null===this.rightHand}addItem(e,t){return"left"===t&&null===this.leftHand?(this.leftHand=e,e):null===this.rightHand?(this.rightHand=e,e):null}takeItem(){if(null!==this.leftHand){const e=this.leftHand;return this.leftHand=null,[e,"left"]}if(null!==this.rightHand){const e=this.rightHand;return this.rightHand=null,[e,"right"]}return null}}class k{#t;#s;constructor(e,t,s){this.health=e,this.maxHealth=e,this.#t=t,this.#s=s}heal(e){this.health=Math.min(this.health+e,this.maxHealth)}damage(e){if(this.health=Math.max(this.health-e,0),0===this.health)if(this.#s===this.#t.player)re("Game Over","Menu",!1),this.#t.paused=!0;else if(this.#t.ecs.hasComponent(this.#s,T)&&f.createBurst(this.#t,17,17,this.#t.ecs.getComponent(this.#s,C).getCentre(this.#t.tileSize),.08,.997,this.#t.ecs.getComponent(this.#s,T).colour),this.#t.ecs.hasComponent(this.#s,R)){this.#t.ecs.addComponent(this.#s,b);const e=this.#t.ecs.getComponent(this.#s,R);e.timeOfDeath=performance.now(),e.timeUntilRespawn=n(...e.timeUntilRespawnRange),this.#t.toRespawn.push(this.#s)}else this.#t.ecs.removeEntity(this.#s)}}class H extends m{constructor(e){super(),this.damage=e}}class M{sneaking=!1}class I{constructor(e){this.canGetTired=e}}class A{}class P{randomWalkAngle=Math.random()*Math.PI*2;timeOflastAngleChange=0;constructor(e,t){this.target=e,this.maxTiles=t}}class T{constructor(e){this.colour=e}}class b{constructor(e){this.shouldUpdate=e}}class R{constructor(e){this.timeUntilRespawnRange=e}}class L{timeOfLastHit=0;timeUntilNextHit=0;constructor(e,t){this.target=e,this.timeBetweenHitsRange=t}}class F extends u{constructor(){super([M,S],p.Keyboard,((e,t)=>{const s=e.ecs.getComponent(t,S);if(e.keys.a||e.keys.arrowleft?e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(-1,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(-1,1):[s.speedX,s.speedY]=s.speedsTo(-1,0):e.keys.d||e.keys.arrowright?e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(1,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(1,1):[s.speedX,s.speedY]=s.speedsTo(1,0):e.keys.w||e.keys.arrowup?[s.speedX,s.speedY]=s.speedsTo(0,-1):e.keys.s||e.keys.arrowdown?[s.speedX,s.speedY]=s.speedsTo(0,1):(s.speedX=0,s.speedY=0),e.keys.shift){s.speedX/=3,s.speedY/=3;e.ecs.getComponent(t,M).sneaking=!0}}))}}class E extends u{constructor(){super([I,S,w],p.Tick,((e,t)=>{const s=e.ecs.getComponent(t,S),o=e.ecs.getComponent(t,w),n=e.ecs.getComponent(t,C);if(0===s.speedX&&0===s.speedY)o.frame.y=0;else{const e=Math.atan2(s.speedY,s.speedX);o.frame.y=0,e>-5*Math.PI/8&&e<-3*Math.PI/8?o.frame.y=16:e>=-3*Math.PI/8&&e<=3*Math.PI/8?o.frame.y=48:(e<=-5*Math.PI/8||e>=5*Math.PI/8)&&(o.frame.y=32)}if(l(e,t),0!==s.speedX||0!==s.speedY){const i=1/s.currentVelocity*400;if(performance.now()-o.timeOflastFrameChange>=i&&(o.frame.x+=16,o.frame.x%=64,o.timeOflastFrameChange=performance.now(),(16===o.frame.x||48===o.frame.x)&&e.shouldPlaySFX)){const o=r(e.getAudio("footstep"));o.volume*=.5,t!==e.player&&(o.volume*=.5),o.volume*=s.currentVelocity/s.velocity;const i=e.ecs.getComponent(e.player,C).pixels.distTo(n.pixels);o.volume*=Math.max(1-i/(e.roomSize.x*e.tileSize),0),o.play()}}else o.frame.x=0;const i=e.ecs.getComponent(t,I);if(e.ecs.hasComponent(t,k)&&i.canGetTired){const o=e.ecs.getComponent(t,k);0!==s.currentVelocity?o.damage(s.currentVelocity/120):o.heal(o.maxHealth/3e3)}t===e.player&&(n.pixels.x<-e.tileSize/2&&n.room.x>0?(n.room.x--,n.pixels.x=e.tileSize*e.roomSize.x-e.tileSize/2):n.pixels.x>e.tileSize*e.roomSize.x-e.tileSize/2&&n.room.x<e.roomSize.x-1?(n.room.x++,n.pixels.x=-e.tileSize/2):n.pixels.y<-e.tileSize/2&&n.room.y>0?(n.room.y--,n.pixels.y=e.tileSize*e.roomSize.y-e.tileSize/2):n.pixels.y>e.tileSize*e.roomSize.y-e.tileSize/2&&n.room.y<e.roomSize.y-1&&(n.room.y++,n.pixels.y=-e.tileSize/2))}))}}class O extends u{constructor(){super([C,w],p.Tick,((e,t)=>{const s=e.ecs.getComponent(t,C),o=e.ecs.getComponent(t,w);if(e.ctx.drawImage(o.image,o.frame.x,o.frame.y,o.frame.width,o.frame.height,s.pixels.x,s.pixels.y,o.dest.x??e.tileSize,o.dest.y??e.tileSize),e.keys.h&&e.ecs.hasComponent(t,z)){const o=e.ecs.getComponent(t,z).getActualHitbox(s);e.ctx.strokeStyle="#ff2222",e.ctx.lineWidth=Math.ceil(e.tileSize/90),e.ctx.strokeRect(o.x,o.y,o.width,o.height)}}))}}class X extends u{constructor(){super([v,C,M],p.RightClick,((e,t)=>{const o=e.ecs.getComponent(t,C),n=e.lastClickPos.x-o.pixels.x,i=e.lastClickPos.y-o.pixels.y;if(Math.hypot(n,i)>5*e.tileSize)return;const r=e.ecs.getComponent(t,v);a(e,r,e.lastClickPos.shifted(new s(-e.tileSize/2,-e.tileSize/2)))}))}}class B extends u{constructor(){super([M,v,C],p.KeyUp,((e,t)=>{if("f"===e.keyReleased){const s=e.ecs.getComponent(t,v);if(s.leftHand&&!s.rightHand){s.rightHand=s.leftHand,s.leftHand=null;e.ecs.getComponent(s.rightHand,C).pixels=e.rightHandItemPos}else if(!s.leftHand&&s.rightHand){s.leftHand=s.rightHand,s.rightHand=null;e.ecs.getComponent(s.leftHand,C).pixels=e.leftHandItemPos}else if(s.leftHand&&s.rightHand){const t=s.leftHand;s.leftHand=s.rightHand,s.rightHand=t;const o=e.ecs.getComponent(s.leftHand,C),n=e.ecs.getComponent(s.rightHand,C);o.pixels=e.leftHandItemPos,n.pixels=e.rightHandItemPos}(s.leftHand||s.rightHand)&&e.shouldPlaySFX&&r(e.getAudio("swap_hands")).play()}if("q"===e.keyReleased){const o=e.ecs.getComponent(t,v),n=e.ecs.getComponent(t,C),i={left:new s(-1,0),right:new s(1,0),above:new s(0,-1),below:new s(0,1)}[e.keys.d?"left":e.keys.a?"right":e.keys.w?"below":e.keys.s?"above":null],r=()=>{for(const t of[0,1,-1])for(const i of[-1,1,0]){if(a(e,o,new s(n.pixels.x+e.tileSize*i,n.pixels.y+e.tileSize*t)))return}};if(i){a(e,o,n.pixels.shifted(i.multiplied(e.tileSize)))||r()}else r()}if("shift"===e.keyReleased){e.ecs.getComponent(t,M).sneaking=!1}}))}}class Y extends u{constructor(){super([k,C],p.Tick,((e,t)=>{const s=e.ecs.getComponent(t,k),o=e.ecs.getComponent(t,C),n=(t,s)=>{e.ctx.fillStyle=t,e.ctx.fillRect(o.pixels.x,o.pixels.y+e.tileSize+4,e.tileSize*s,e.tileSize/8)};n("#ccc",1),n(`hsl(${s.health/s.maxHealth*100}, 100%, 50%)`,s.health/s.maxHealth)}))}}class W extends u{constructor(){super([H],p.Tick,((e,t)=>{const s=e.ecs.getComponent(t,H);if(s.frameCount<s.totalFrames){s.frameCount++;const o=e.ecs.getComponent(t,w),n=e.ecs.getComponent(s.holder,C).pixels.centred(e.tileSize);e.ctx.save(),e.ctx.translate(s.pivotPointOffset.x+n.x,s.pivotPointOffset.y+n.y),e.ctx.rotate(s.startAngle+s.swingRadians*s.frameCount/s.totalFrames),e.ctx.drawImage(o.image,o.frame.x,o.frame.y,o.frame.width,o.frame.height,0,.8*-e.tileSize,.8*e.tileSize,.8*e.tileSize),e.ctx.restore()}}))}}class q extends u{constructor(){super([P,C],p.Tick,((e,t)=>{const s=e.ecs.getComponent(t,P),o=e.ecs.getComponent(t,C),n=e.ecs.getComponent(s.target,C),i=n.pixels.distTo(o.pixels);let a=s.maxTiles*e.tileSize;if(s.target===e.player){e.ecs.getComponent(e.player,M).sneaking&&(a/=2)}const r=e.ecs.getComponent(t,S);if(i<a){const e=n.pixels.x-o.pixels.x,t=n.pixels.y-o.pixels.y;[r.speedX,r.speedY]=r.speedsTo(e,t)}else r.speedX=Math.cos(s.randomWalkAngle)*r.velocity,r.speedY=Math.sin(s.randomWalkAngle)*r.velocity,performance.now()-s.timeOflastAngleChange>3e3&&Math.random()<.1&&(s.randomWalkAngle+=Math.PI/4+Math.random()*Math.PI/4*(Math.random()<.5?1:-1),s.randomWalkAngle%=2*Math.PI,s.timeOflastAngleChange=performance.now());e.keys.h&&(e.ctx.beginPath(),e.ctx.moveTo(o.pixels.x+e.tileSize/2,o.pixels.y+e.tileSize/2),i<a?e.ctx.lineTo(n.pixels.x+e.tileSize/2,n.pixels.y+e.tileSize/2):e.ctx.lineTo(o.pixels.x+Math.cos(s.randomWalkAngle)*e.canvas.width,o.pixels.y+Math.sin(s.randomWalkAngle)*e.canvas.width),e.ctx.fillStyle="red",e.ctx.stroke())}))}}const U=(e,t,o)=>{const n=e.ecs.getComponent(t,v),i=e.ecs.hasComponent(n.rightHand,H)?n.rightHand:e.ecs.hasComponent(n.leftHand,H)?n.leftHand:null;if(i){const n=e.ecs.getComponent(i,H);n.holder=t,n.frameCount=0,n.totalFrames=15;const a=e.ecs.getComponent(t,C),r=e.ecs.getComponent(o,C);n.startAngle=a.pixels.angleTo(r?.pixels||e.lastClickPos),n.swingRadians=Math.PI/3,n.pivotPointOffset=new s(Math.cos(n.startAngle)*e.tileSize/5,Math.sin(n.startAngle)*e.tileSize/5)}if(null!==o)if(e.ecs.hasComponent(o,A))if(n.hasSpace()){const i=n.addItem(o,"left"),a=e.ecs.getComponent(i,C);t===e.player?a.pixels=n.leftHand===i?e.leftHandItemPos:e.rightHandItemPos:a.pixels=new s(0,0),a.room=e.ecs.getComponent(t,C).room,e.shouldPlaySFX&&r(e.getAudio("pick_up")).play()}else e.shouldPlaySFX&&r(e.getAudio("decline")).play();else if(i&&e.ecs.hasComponent(o,k)){const t=e.ecs.getComponent(o,k),s=e.ecs.getComponent(i,H).damage;t.damage(s)}};class G extends u{constructor(){super([M,C,v],p.Click,((e,t)=>{const s=e.ecs.getComponent(t,C),n=e.roomAt(e.playerRoomPos).entities.slice().reverse().find((n=>{if(!e.ecs.hasComponent(n,A)&&!e.ecs.hasComponent(n,k))return!1;if(n===t)return!1;const i=e.ecs.getComponent(n,C);if(s.pixels.distTo(i.pixels)>e.tileSize*e.minHitDist)return!1;let a=!1;e.ecs.hasComponent(n,z)||(e.ecs.addComponent(n,z,[new o(0,0,e.tileSize,e.tileSize)]),a=!0);const r=e.ecs.getComponent(n,z),l=e.lastClickPos.isInside(r.getActualHitbox(i));return a&&e.ecs.removeComponent(n,z),l}));U(e,t,n??null)}))}}class V extends u{constructor(){super([],p.Tick,(e=>{for(const[t,o]of e.particles.entries())o.pos=o.pos.shifted(new s(o.speed*Math.cos(o.angle),o.speed*Math.sin(o.angle))),o.speed*=o.friction,o.speed<.004&&e.particles.splice(t,1),e.ctx.fillStyle=o.colour,e.ctx.fillRect(o.pos.x,o.pos.y,5,5)}))}}const K=(e,t,s,o,n)=>{const i=e.ecs.createEntity();return n&&e.ecs.addComponent(i,z,[n]),c(e,t,i),e.ecs.addComponent(i,w,[s,o]),e.ecs.addComponent(i,A),i},N=(e,t)=>{const n=e.ecs.createEntity();e.ecs.addComponent(n,w,[e.getImage("zombie"),new o(0,0,16,16)]),e.ecs.addComponent(n,z,[o.fromVecs(new s(2,0).scaled(16,e.tileSize).shifted(new s(0,2)),new s(12,16).scaled(16,e.tileSize).shifted(new s(0,-2)))]),c(e,t,n);const i=e.ecs.getComponent(e.player,S).velocity;e.ecs.addComponent(n,S,[i/3+i/3*(e.level/se.maxLevel)]),e.ecs.addComponent(n,P,[e.player,e.roomSize.x/2+e.roomSize.x/2*e.level/se.maxLevel]),e.ecs.addComponent(n,k,[10+e.level/se.maxLevel*110,e,n]);const a=1e3-500*e.level/se.maxLevel;e.ecs.addComponent(n,L,[e.player,[a,a+1e3]]);const r=8e3-5e3*e.level/se.maxLevel;e.ecs.addComponent(n,R,[[r,r+5e3]]);const l=e.ecs.createEntity();e.ecs.addComponent(l,w,[e.getImage("items"),new o(0,16,16,16)]),e.ecs.addComponent(l,C,[new s(e.canvas.width,e.canvas.height),t.pos]),e.ecs.addComponent(l,A),e.ecs.addComponent(l,H,[5]),e.ecs.addComponent(n,v,[l,null]),e.ecs.addComponent(n,I,[!1]),e.ecs.addComponent(n,T,["#bb0000"])},D=e=>{for(const t of e.rooms){for(let s=0;s<n(5,10);s++)K(e,t,e.getImage("items"),new o(0,0,16,16),new o(1,1,e.tileSize-1,e.tileSize-1));for(let s=0;s<Math.round(e.level/3);s++)N(e,t)}const t=K(e,e.roomAt(e.playerRoomPos),e.getImage("items"),new o(0,16,16,16));e.ecs.addComponent(t,H,[5])},_=(e,t)=>{const n=e.ecs.createEntity();return e.ecs.addComponent(n,C,[t,new s(Math.floor(e.roomCount.x/2),Math.floor(e.roomCount.y/2))]),e.ecs.addComponent(n,w,[e.getImage("player"),new o(0,0,16,16)]),e.ecs.addComponent(n,S,[2]),e.ecs.addComponent(n,I,[!0]),e.ecs.addComponent(n,M),e.ecs.addComponent(n,v,[null,null]),e.ecs.addComponent(n,k,[100,e,n]),e.ecs.addComponent(n,z,[o.fromVecs(new s(2,0).scaled(16,e.tileSize).shifted(new s(0,2)),new s(12,16).scaled(16,e.tileSize).shifted(new s(0,-2)))]),n};let j;var $;($=j||(j={}))[$.ShortGrass=0]="ShortGrass",$[$.TallGrass=1]="TallGrass",$[$.Flowers1=2]="Flowers1",$[$.Flowers2=3]="Flowers2";class Q{tiles=[];constructor(e,t){this.game=e,this.pos=t;for(let e=0;e<this.game.roomSize.y;e++){this.tiles.push([]);for(let t=0;t<this.game.roomSize.x;t++)if(0==t||0==e||t==this.game.roomSize.x-1||e==this.game.roomSize.y-1)this.tiles[e].push(j.ShortGrass);else{const t=Math.random()<.8?j.ShortGrass:Math.random()<.7?j.TallGrass:Math.random()<.5?j.Flowers1:j.Flowers2;this.tiles[e].push(t)}}}render(){this.game.ctx.clearRect(0,0,this.game.canvas.width,this.game.canvas.height);for(let e=0;e<this.game.roomSize.y;e++)for(let t=0;t<this.game.roomSize.x;t++){const s=this.tiles[e][t],o=this.game.tileSize;this.game.ctx.drawImage(this.game.getImage("tiles"),16*s,0,16,16,t*o,e*o,o,o)}}get entities(){return[this.game.leftHandItemBox,this.game.rightHandItemBox].concat(this.game.ecs.entities.filter((e=>!!this.game.ecs.hasComponent(e,C)&&s.equal(this.game.ecs.getComponent(e,C).room,this.pos))))}}const J=(e,t,s)=>{const o=n(e,t-e-s);return Array(s).fill(null).map(((e,t)=>o+t))},Z=e=>{const t=[];for(let n=0;n<e.roomCount.y;n++)for(let i=0;i<e.roomCount.x;i++){const a=new s(i,n),r=new Q(e,a);r.doors={top:J(5,e.roomSize.x,4),bottom:J(5,e.roomSize.x,4),left:J(3,e.roomSize.y,3),right:J(3,e.roomSize.y,3)},0===i&&(r.doors.left=[]),0===n&&(r.doors.top=[]),i===e.roomCount.x-1&&(r.doors.right=[]),n===e.roomCount.y-1&&(r.doors.bottom=[]);const l=e=>t.find((t=>s.equal(t.pos,e))),c=(e,t,s)=>{l(e)&&(t.doors[s]=l(e).doors[{top:"bottom",bottom:"top",left:"right",right:"left"}[s]])};c(a.shifted(new s(0,-1)),r,"top"),c(a.shifted(new s(0,1)),r,"bottom"),c(a.shifted(new s(-1,0)),r,"left"),c(a.shifted(new s(1,0)),r,"right"),t.push(r);for(let t=0;t<e.roomSize.y;t++)for(let n=0;n<e.roomSize.x;n++)if(0===n||0===t||n===e.roomSize.x-1||t===e.roomSize.y-1){const i=e.ecs.createEntity();let l;e.ecs.addComponent(i,C,[new s(n*e.tileSize,t*e.tileSize),a]);let c=[new s(0,0),new s(16,16)];0===n?0===t?l=[0,48]:t===e.roomSize.y-1?l=[32,48]:t===r.doors.left[0]-1?(l=[48,32],c=[new s(0,0),new s(14,14)]):t===r.doors.left[r.doors.left.length-1]+1?(l=[16,32],c=[new s(0,2),new s(14,14)]):r.doors.left.includes(t)?e.ecs.removeEntity(i):(l=[48,16],c=[new s(0,0),new s(14,16)]):n===e.roomSize.x-1?0===t?l=[16,48]:t===e.roomSize.y-1?l=[48,48]:t===r.doors.right[0]-1?(l=[32,32],c=[new s(2,0),new s(14,14)]):t===r.doors.right[r.doors.right.length-1]+1?(l=[0,32],c=[new s(2,2),new s(14,14)]):r.doors.right.includes(t)?e.ecs.removeEntity(i):(l=[16,16],c=[new s(2,0),new s(14,16)]):0===t?n===r.doors.top[0]-1?(l=[48,32],c=[new s(0,0),new s(14,14)]):n===r.doors.top[r.doors.top.length-1]+1?(l=[32,32],c=[new s(2,0),new s(14,14)]):r.doors.top.includes(n)?e.ecs.removeEntity(i):(l=[0,16],c=[new s(0,0),new s(16,14)]):t===e.roomSize.y-1&&(n===r.doors.bottom[0]-1?(l=[16,32],c=[new s(0,2),new s(14,14)]):n===r.doors.bottom[r.doors.bottom.length-1]+1?(l=[0,32],c=[new s(2,2),new s(14,14)]):r.doors.bottom.includes(n)?e.ecs.removeEntity(i):(l=[32,16],c=[new s(0,2),new s(16,14)])),e.ecs.addComponent(i,w,[e.getImage("tiles"),new o(...l??[0,0],16,16)]),e.ecs.addComponent(i,z,[o.fromVecs(...c.map((t=>t.scaled(16,e.tileSize))))])}}return t};class ee extends u{constructor(){super([],p.Tick,(e=>{for(const t of e.toRespawn){const s=e.ecs.getComponent(t,R);if(performance.now()-s.timeOfDeath>s.timeUntilRespawn){e.ecs.removeComponent(t,b);const s=e.ecs.getComponent(t,k);s.heal(s.maxHealth);const o=e.ecs.getComponent(t,C);i(e,t)&&c(e,e.roomAt(o.room),t),e.ecs.bringToFront(t),e.toRespawn.splice(e.toRespawn.indexOf(t),1)}}}))}}class te extends u{constructor(){super([L,C],p.Tick,((e,t)=>{const s=e.ecs.getComponent(t,L);if(null===s.target)return;const o=e.ecs.getComponent(t,C),i=e.ecs.getComponent(s.target,C);o.pixels.distTo(i.pixels)<e.tileSize*e.minHitDist&&performance.now()-s.timeOfLastHit>s.timeUntilNextHit&&(s.timeOfLastHit=performance.now(),s.timeUntilNextHit=n(...s.timeBetweenHitsRange),U(e,t,s.target))}))}}class se{static maxLevel=15;paused=!1;eventListeners={};ecs=new x(this);toRespawn=[];particles=[];minHitDist=1.7;timeOfLastFrame=0;keys={};constructor(e,t,o,n,i){if(this.canvas=e,this.ctx=e.getContext("2d"),!(o>0&&o<=se.maxLevel))throw new Error(`Level ${o} does not exist`);this.level=o,this.assets=t,this.shouldPlayMusic=n,this.shouldPlaySFX=i,this.roomCount=new s(Math.ceil(o/2),Math.ceil(o/2)),o%2==0&&this.roomCount.x++,this.roomSize=new s(null,null),this.roomSize.y=Math.floor(9*(innerHeight/innerWidth+1)),this.tileSize=Math.floor(innerHeight/this.roomSize.y),this.roomSize.x=Math.floor(innerWidth/this.tileSize),this.canvas.width=this.roomSize.x*this.tileSize,this.canvas.height=this.roomSize.y*this.tileSize,this.ctx.imageSmoothingEnabled=!1,this.player=_(this,new s((this.roomSize.x/2-.5)*this.tileSize,(this.roomSize.y/2-.5)*this.tileSize)),[this.leftHandItemBox,this.leftHandItemPos]=this.addItemBox(new s(this.tileSize,(this.roomSize.y-4)*this.tileSize)),[this.rightHandItemBox,this.rightHandItemPos]=this.addItemBox(new s((this.roomSize.x-4)*this.tileSize,(this.roomSize.y-4)*this.tileSize)),this.rooms=Z(this),D(this);for(const e of this.rooms)this.ecs.entitiesWithComponents(e,[I]).forEach(this.ecs.bringToFront,this.ecs);[F,q,E,G,B,X,ee,te,O,Y,W,V].forEach((e=>this.ecs.systemManager.addSystem(new e)))}setLastClickPos(e){const t=this.canvas.getBoundingClientRect();this.lastClickPos=new s(e.clientX-t.left,e.clientY-t.top)}addItemBox(e){const t=this.ecs.createEntity();return this.ecs.addComponent(t,w,[this.getImage("item_box"),new o(0,0,48,48),new s(3*this.tileSize,3*this.tileSize)]),this.ecs.addComponent(t,C,[e,this.playerRoomPos]),this.ecs.addComponent(t,z,[o.fromVecs(new s(11,11).scaled(16,this.tileSize),new s(26,26).scaled(16,this.tileSize))]),[t,e.shifted(new s(this.tileSize,this.tileSize))]}get playerRoomPos(){return this.ecs.getComponent(this.player,C).room}roomAt(e){return this.rooms.find((t=>s.equal(t.pos,e)))}getAsset(e){const t=[];for(const e in this.assets)t.push(...this.assets[e]);return t.find((t=>new RegExp(`${e}\\.[^\\.]+`).test(t.src)))}getImage(e){return this.getAsset(e)}getAudio(e){return this.getAsset(e)}addEventListeners(){const e={blur:this.pause.bind(this),keydown:e=>{const t=e.key.toLowerCase();"p"!==t&&"escape"!==t||this.pause(),this.keys[t]=!0,this.ecs.systemManager.updateSystems(p.Keyboard)},keyup:e=>{const t=e.key.toLowerCase();this.keyReleased=t,this.ecs.systemManager.updateSystems(p.KeyUp),delete this.keys[t],this.ecs.systemManager.updateSystems(p.Keyboard)},click:e=>{this.setLastClickPos(e),this.ecs.systemManager.updateSystems(p.Click)},contextmenu:e=>{e.preventDefault(),this.setLastClickPos(e),this.ecs.systemManager.updateSystems(p.RightClick)}};for(const t in e)document.addEventListener(t,e[t]);return e}removeEventListeners(){Object.entries(this.eventListeners).forEach((([e,t])=>{document.removeEventListener(e,t)}))}start(){if(this.paused=!1,this.eventListeners=this.addEventListeners(),this.startTime=performance.now(),this.timeOfLastFrame=performance.now(),this.tick(performance.now()),this.shouldPlayMusic){const e=this.getAudio("music");e.loop=!0,e.volume=.5,e.play()}}pause(){this.paused||(re("Game Paused","Quit",!0),this.removeEventListeners(),this.paused=!0,this.getAudio("music").pause())}tick(e){this.paused||(this.currentFrameRate=1e3/(e-this.timeOfLastFrame),this.timeOfLastFrame=e,this.roomAt(this.playerRoomPos).render(),this.ecs.systemManager.updateSystems(p.Tick),requestAnimationFrame((e=>this.tick(e))))}}function oe(e){return document.querySelector(e)}const[ne,ie]=Array.from(document.querySelectorAll(".level-selector button")),ae=()=>{const e=parseInt(oe(".level").innerText);ne.disabled=1===e,ie.disabled=e===se.maxLevel};ne.onclick=()=>{const e=oe(".level");parseInt(e.innerText)>1&&(e.textContent=(parseInt(e.textContent)-1).toString()),ae()},ie.onclick=()=>{const e=oe(".level");parseInt(e.innerText)<se.maxLevel&&(e.textContent=(parseInt(e.textContent)+1).toString()),ae()};oe(".menu-button").onclick=()=>{oe(".game-stopped").hidden=!0,oe(".menu").hidden=!1,ae()},oe(".resume-button").onclick=()=>{oe(".game-stopped").hidden=!0,oe("canvas").hidden=!1,window.game.start()};const re=(e,t,s)=>{oe("canvas").hidden=!0,oe(".game-stopped").hidden=!1,oe(".game-stopped .message").textContent=e,oe(".game-stopped .menu-button").textContent="< "+t,oe(".game-stopped .resume-button").disabled=!s};document.querySelectorAll(".switch").forEach((e=>{e.addEventListener("click",(()=>{e.textContent="ON"===e.textContent?"OFF":"ON"}))}));const le=new class{#o=[];#n;#i=0;constructor(e,t){this.#o=e,this.progressBar=t}adjustProgressBar(){this.progressBar.style.width=`calc((100% - 1vh) * ${this.#i/this.#o.length})`}loadAsset(t){return new Promise(((s,o)=>{if(t.type===e.Image){const e=new Image;e.src=t.path,e.onload=()=>{s(e),this.#i++,this.adjustProgressBar()},e.onerror=o}else if(t.type===e.Audio){const e=new Audio;e.src=t.path,e.oncanplaythrough=()=>{s(e),this.#i++,this.adjustProgressBar()},e.onerror=o}}))}async loadAll(){this.#n=this.#o.map(this.loadAsset,this);const e=await Promise.all(this.#n);return await new Promise((e=>setTimeout(e,1e3))),{images:e.filter((e=>e instanceof HTMLImageElement)),audio:e.filter((e=>e instanceof HTMLAudioElement))}}}([{type:e.Image,path:"assets/images/tiles.png"},{type:e.Image,path:"assets/images/player.png"},{type:e.Image,path:"assets/images/items.png"},{type:e.Image,path:"assets/images/item_box.png"},{type:e.Image,path:"assets/images/zombie.png"},{type:e.Audio,path:"assets/sounds/music.mp3"},{type:e.Audio,path:"assets/sounds/footstep.mp3"},{type:e.Audio,path:"assets/sounds/pick_up.mp3"},{type:e.Audio,path:"assets/sounds/place.mp3"},{type:e.Audio,path:"assets/sounds/swap_hands.mp3"},{type:e.Audio,path:"assets/sounds/decline.mp3"}],oe(".loading .inner"));document.fonts.ready.then((async()=>{const e=oe(".loading");e.hidden=!1;const t=await le.loadAll();e.hidden=!0,oe(".menu").hidden=!1,oe(".game-stopped").hidden=!0,ae(),oe(".play-button").onclick=()=>{oe(".menu").hidden=!0;const e=parseInt(oe(".level").innerText),s=oe("canvas");s.hidden=!1;const o="ON"===oe(".music").textContent,n="ON"===oe(".sfx").textContent;window.game=new se(s,t,e,o,n),window.game.getAudio("music").currentTime=0,window.game.start()}}));